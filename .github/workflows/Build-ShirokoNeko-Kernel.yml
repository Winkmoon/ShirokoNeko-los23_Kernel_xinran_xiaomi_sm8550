
name: Build GudzonKernel (Vermeer A16)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Install Toolchain (AOSP Clang 19)
        run: |
          sudo apt-get update && sudo apt-get install -y bc bison build-essential flex git lld llvm python3 rsync libssl-dev libelf-dev zip
          mkdir -p $GITHUB_WORKSPACE/clang-aosp
          curl -Lo clang.tar.gz https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r530567.tar.gz
          tar -C $GITHUB_WORKSPACE/clang-aosp -xzf clang.tar.gz

      - name: Integrate SukiSU & SUSFS 2.0
        run: |
          # Интеграция SukiSU
          git clone --depth=1 https://github.com/SukiSU-Ultra/SukiSU-Ultra.git sukisu-temp
          chmod +x sukisu-temp/setup.sh
          ./sukisu-temp/setup.sh susfs-main
          rm -rf sukisu-temp
          
          # Интеграция SUSFS Patches
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b kernel-6.1 /tmp/susfs
          cp /tmp/susfs/kernel/include/linux/susfs.h include/linux/
          cp /tmp/susfs/kernel/fs/susfs.c fs/
          
          # Применение патчей к файловой системе (VFS)
          patch -p1 < /tmp/susfs/kernel/fs/0001-vfs-Add-susfs-hooks-to-vfs-6.1.patch
          patch -p1 < /tmp/susfs/kernel/include/linux/0001-vfs-Add-susfs-hooks-to-vfs-6.1.patch

      - name: Configure GudzonKernel
        run: |
          export PATH=$GITHUB_WORKSPACE/clang-aosp/bin:$PATH
          export ARCH=arm64
          
          # Создаем конфиг из GKI дефконфига
          make O=out vendor/gki_defconfig
          
          chmod +x scripts/config
          
          # --- ИМЯ ЯДРА ---
          ./scripts/config --file out/.config --set-str LOCALVERSION "-GudzonKernel"
          
          # --- НАСТРОЙКИ СКРЫТИЯ (SUSFS) ---
          ./scripts/config --file out/.config -e SUSFS
          ./scripts/config --file out/.config -e KSU_SUSFS
          ./scripts/config --file out/.config -e SUSFS_MAGIC_MOUNT
          ./scripts/config --file out/.config -e SUSFS_SPOOF_UNAME
          
          # --- БЕЗОПАСНОСТЬ И СТАБИЛЬНОСТЬ ---
          ./scripts/config --file out/.config -d MODULE_SIG
          ./scripts/config --file out/.config -d DEBUG_INFO_BTF
          ./scripts/config --file out/.config -d LTO_CLANG_FULL
          ./scripts/config --file out/.config -e LTO_CLANG_THIN
          
          make O=out olddefconfig

      - name: Compilation (GudzonKernel Build)
        run: |
          export PATH=$GITHUB_WORKSPACE/clang-aosp/bin:$PATH
          make -j$(nproc --all) O=out \
            ARCH=arm64 \
            CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-gnu- \
            LLVM=1 LLVM_IAS=1 \
            Image dtbo.img

      - name: Package for Vermeer (AnyKernel3)
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git
          cp out/arch/arm64/boot/Image AnyKernel3/
          [ -f out/arch/arm64/boot/dtbo.img ] && cp out/arch/arm64/boot/dtbo.img AnyKernel3/
          
          cd AnyKernel3
          # Настраиваем AnyKernel под наше имя
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          sed -i 's/block=auto/block=auto/g' anykernel.sh # На всякий случай
          
          zip -r9 "../GudzonKernel-Vermeer-A16-SukiSU.zip" *

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GudzonKernel-Package
          path: ./*.zip
